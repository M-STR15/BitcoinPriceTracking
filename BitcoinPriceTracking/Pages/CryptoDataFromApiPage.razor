@page "/crypto-data-from-api"
@using BitcoinPriceTracking.BE.Shared.Models.DTOs
@using BitcoinPriceTracking.Data
@using System.Reflection

 @inherits BasePage

<PageTitle>Crypto data - BTC</PageTitle>
<h1>Crypto data - BTC</h1>
<p>Zobrazuje surová data z https://data-api.coindesk.com/spot/v1/latest/tick?market=coinbase&instruments=BTC-EUR</p>

@if (_cryptoDataDto == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <button @onclick="addAddCryptoDataToDb_Click">Add actual data to database</button> 
    <table class="table table-striped table-bordered">
        <tbody>
            @if (_properties != null)
            {
                @foreach (var prop in _properties)
                {
                    <tr>
                        <th>@prop.Name</th>
                        <td>@(prop.GetValue(_cryptoDataDto) ?? "-")</td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@code {
    private CryptoDataDto? _cryptoDataDto;
    private PropertyInfo[]? _properties = Array.Empty<PropertyInfo>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (_httpClient != null)
            {
                var response = await _httpClient.GetAsync("api/v1/crypto-data/buffer/BTC-EUC");

                if (response.StatusCode == System.Net.HttpStatusCode.OK)
                {
                    _cryptoDataDto = await response.Content.ReadFromJsonAsync<CryptoDataDto>();
                    if (_cryptoDataDto != null)
                        _properties = _cryptoDataDto.GetType().GetProperties(BindingFlags.Public | BindingFlags.Instance);
                }
            }
        }
        catch (Exception ex)
        {
            var test = ex;
        }
    }

    private async void addAddCryptoDataToDb_Click()
    {
        if (_httpClient != null)
        {
            var aaa = await _httpClient.PostAsJsonAsync<CryptoDataDto>("/api/v1/crypto-data/database", _cryptoDataDto);
        }
    }
}
